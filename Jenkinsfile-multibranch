#!/usr/bin/env groovy
@Library('jenkins-pipeline-lib') _

node {
    def commitHash
    cleanWs()

    stage("checkout") {
        checkout scm

        commitHash = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
    }
    stage("build") {
        try {
            sh "make build"
        } catch (e) {
            junit('build/test-results/test/**/*.xml')
            publishHTML([
                    allowMissing         : false,
                    alwaysLinkToLastBuild: false,
                    keepAll              : true,
                    reportDir            : 'build/reports/tests/test',
                    reportFiles          : 'index.html',
                    reportName           : 'HTML Report',
                    reportTitles         : ''
            ])

            throw e
        }
    }
    stage("test") {
        try {
            sh "make test"
        } catch (e) {
            junit('build/test-results/test/**/*.xml')
            publishHTML([
                    allowMissing         : false,
                    alwaysLinkToLastBuild: false,
                    keepAll              : true,
                    reportDir            : 'build/reports/tests/test',
                    reportFiles          : 'index.html',
                    reportName           : 'HTML Report',
                    reportTitles         : ''
            ])

            throw e
        }
    }
    
}
